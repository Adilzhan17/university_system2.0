{% extends 'student_base.html' if current_user_obj and current_user_obj.role == 'student' else 'base.html' %}
{% block title %}Результаты AI опроса{% endblock %}
{% block content %}
<div class="surface mb-3">
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
    <div>
      <h2 class="mb-1">Рекомендации по ЕНТ</h2>
      <p class="text-muted mb-0">Детерминированные правила на основе выбранных ответов. Сохранено: {{ result.created_at.strftime('%Y-%m-%d %H:%M') if result.created_at else '' }}</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('ai_test') }}"><i class="bi bi-arrow-left me-1"></i>Пройти заново</a>
    </div>
  </div>
</div>

<div class="row g-3">
  {% if top %}
  <div class="col-12">
    <div class="surface">
      <h5 class="mb-2">Лучшая комбинация</h5>
      <div class="fw-semibold">{{ top[0].title }}</div>
      <div class="text-muted small mb-2">{{ top[0].description }}</div>
      {% if top[0].best_specialty %}
      <div class="small mb-2">Лучшая специальность: <strong>{{ top[0].best_specialty.title }} ({{ top[0].best_specialty.code }})</strong></div>
      {% endif %}
      <div class="small">Подходящие направления и факультеты:</div>
      <ul class="small mb-3">
        {% for f in top[0].faculties %}
        <li>{{ f }}</li>
        {% endfor %}
      </ul>
      {% if top[0].specialties %}
      <div class="small">Примеры специальностей:</div>
      <ul class="small mb-3">
        {% for s in top[0].specialties[:5] %}
        <li>{{ s.title }} ({{ s.code }})</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if top|length > 1 %}
      <div class="small text-muted">Альтернативные комбинации:</div>
      <div class="small">
        {{ top[1].title }}{% if top|length > 2 %}, {{ top[2].title }}{% endif %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% for item in top %}
  <div class="col-md-4">
    <div class="surface h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">{{ item.title }}</h5>
        <span class="badge text-bg-primary">Баллы: {{ item.score }}</span>
      </div>
      <p class="text-muted small mb-2">{{ item.description }}</p>
      <div class="small text-muted mb-2">Рекомендация выбрана, потому что ответы дали высокий вес этой комбинации.</div>
      {% if item.best_specialty %}
      <div class="small mb-2">Лучшая специальность: <strong>{{ item.best_specialty.title }} ({{ item.best_specialty.code }})</strong></div>
      {% endif %}
      <div class="small">Карьерные треки:</div>
      <ul class="small mb-0">
        {% for c in item.careers %}
        <li>{{ c }}</li>
        {% endfor %}
      </ul>
      {% if item.faculties %}
      <div class="small mt-2">Направления и факультеты:</div>
      <ul class="small mb-0">
        {% for f in item.faculties %}
        <li>{{ f }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% if item.specialties %}
      <div class="small mt-2">Примеры специальностей:</div>
      <ul class="small mb-0">
        {% for s in item.specialties[:3] %}
        <li>{{ s.title }} ({{ s.code }})</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </div>
  {% else %}
  <div class="col-12">
    <div class="alert alert-warning mb-0">Рекомендации не найдены. Пройдите опрос.</div>
  </div>
  {% endfor %}
</div>

<div class="surface mt-4">
  <h6 class="mb-3">Детализация баллов по комбинациям</h6>
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Комбинация</th>
          <th>Баллы</th>
          <th>Описание</th>
        </tr>
      </thead>
      <tbody>
        {% for key, value in sorted_scores %}
        {% set meta = combinations.get(key, {}) %}
        <tr>
          <td><strong>{{ meta.title or key }}</strong></td>
          <td>{{ value }}</td>
          <td class="text-muted small">{{ meta.description or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
